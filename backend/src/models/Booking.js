import mongoose from "mongoose";

const bookingSchema = new mongoose.Schema(
  {
    user: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true
    },
    driver: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Driver"
    },
    pickupLocation: {
      type: String,
      required: true
    },
    pickupLatitude: {
      type: Number,
      default: 0
    },
    pickupLongitude: {
      type: Number,
      default: 0
    },
    dropLocation: {
      type: String,
      required: true
    },
    dropLatitude: {
      type: Number,
      default: 0
    },
    dropLongitude: {
      type: Number,
      default: 0
    },
    rideType: {
      type: String,
      enum: ["normal", "outstation"],
      default: "normal"
    },
    vehicleType: {
      type: String,
      enum: ["mini", "sedan", "suv", "prime", "auto", "bike"],
      default: "mini"
    },
    bookingType: {
      type: String,
      enum: ["now", "schedule"],
      default: "now"
    },
    scheduledDate: {
      type: Date,
      default: null
    },
    status: {
      type: String,
      enum: ["pending", "scheduled", "accepted", "driver_assigned", "arrived", "started", "waiting", "return_ride_started", "completed", "cancelled"],
      default: "pending"
    },
    otp: {
      type: String,
      default: () => Math.floor(1000 + Math.random() * 9000).toString()
    },
    fare: {
      type: Number,
      default: 0
    },
    distance: {
      type: Number,
      default: 0
    },
    duration: {
      type: Number,
      default: 0
    },
    paymentStatus: {
      type: String,
      enum: ["pending", "paid", "failed", "refunded"],
      default: "pending"
    },
    paymentMethod: {
      type: String,
      enum: ["cash", "card", "upi", "wallet"],
      default: "cash"
    },
    cancellationReason: {
      type: String,
      default: ""
    },
    cancelledBy: {
      type: String,
      enum: ["user", "driver", "system"]
    },
    driverArrivedAt: {
      type: Date,
      default: null
    },
    rideStartedAt: {
      type: Date,
      default: null
    },
    rideCompletedAt: {
      type: Date,
      default: null
    },
    waitingTime: {
      type: Number,
      default: 0
    },
    waitingLimit: {
      type: Number,
      default: 3600 // 1 hour in seconds
    },
    waitingStartedAt: {
      type: Date,
      default: null
    },
    isWaiting: {
      type: Boolean,
      default: false
    },
    penaltyApplied: {
      type: Number,
      default: 0
    },
    lastPenaltyAppliedAt: {
      type: Date,
      default: null
    },
    baseFare: {
      type: Number,
      default: 0
    },
    distanceFare: {
      type: Number,
      default: 0
    },
    timeFare: {
      type: Number,
      default: 0
    },
    discount: {
      type: Number,
      default: 0
    },
    surgeFare: {
      type: Number,
      default: 0
    },
    hasReturnTrip: {
      type: Boolean,
      default: false
    },
    returnTripFare: {
      type: Number,
      default: 0
    },
    rating: {
      type: Number,
      default: 0
    },
    feedback: {
      type: String,
      default: ""
    },
    nearbyNotificationSent: {
      type: Boolean,
      default: false
    },
    totalFare: {
      type: Number,
      default: 0
    }
  },
  { timestamps: true }
);

export default mongoose.model("Booking", bookingSchema);
